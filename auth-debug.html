<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Debug - Rupiya</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status {
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-weight: bold;
    }
    .success { background: #e8f5e9; color: #2e7d32; }
    .error { background: #ffebee; color: #c62828; }
    .warning { background: #fff3e0; color: #ef6c00; }
    .info { background: #e3f2fd; color: #1565c0; }
    button {
      padding: 12px 24px;
      margin: 5px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      font-weight: bold;
    }
    .btn-primary { background: #4A90E2; color: white; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .btn-warning { background: #ff9800; color: white; }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
    h2 { color: #333; border-bottom: 2px solid #4A90E2; padding-bottom: 10px; }
    .log-entry {
      padding: 8px;
      margin: 5px 0;
      border-left: 3px solid #4A90E2;
      background: #f9f9f9;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>üîç Auth Debug Tool</h1>
  
  <div class="section">
    <h2>Current Status</h2>
    <div id="authStatus" class="status info">Checking...</div>
    <div id="persistenceStatus" class="status info">Checking...</div>
  </div>
  
  <div class="section">
    <h2>Actions</h2>
    <button class="btn-primary" onclick="checkAuth()">Check Auth Status</button>
    <button class="btn-success" onclick="testLogin()">Test Login (Google)</button>
    <button class="btn-warning" onclick="checkLocalStorage()">Check Local Storage</button>
    <button class="btn-danger" onclick="clearEverything()">Clear Everything & Logout</button>
    <button class="btn-primary" onclick="goToFamily()">Go to Family Page</button>
  </div>
  
  <div class="section">
    <h2>Auth Details</h2>
    <pre id="authDetails">Loading...</pre>
  </div>
  
  <div class="section">
    <h2>Local Storage</h2>
    <pre id="localStorageDetails">Loading...</pre>
  </div>
  
  <div class="section">
    <h2>Console Logs</h2>
    <div id="logs"></div>
  </div>
  
  <script type="module">
    import { auth } from './assets/js/config/firebase-config.js';
    import authService from './assets/js/services/auth-service.js';
    import { 
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence,
      GoogleAuthProvider,
      signInWithPopup
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
    
    const logs = document.getElementById('logs');
    
    function addLog(message, type = 'info') {
      const div = document.createElement('div');
      div.className = 'log-entry';
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logs.insertBefore(div, logs.firstChild);
      console.log(message);
    }
    
    // Check auth status
    window.checkAuth = async function() {
      addLog('Checking auth status...');
      
      try {
        // Check Firebase auth directly
        const currentUser = auth.currentUser;
        addLog(`Firebase auth.currentUser: ${currentUser ? currentUser.email : 'null'}`);
        
        // Check auth service
        await authService.init();
        const serviceUser = authService.getCurrentUser();
        addLog(`Auth service user: ${serviceUser ? serviceUser.email : 'null'}`);
        
        // Update status
        const statusDiv = document.getElementById('authStatus');
        if (currentUser) {
          statusDiv.className = 'status success';
          statusDiv.textContent = `‚úÖ Logged in as: ${currentUser.email}`;
        } else {
          statusDiv.className = 'status error';
          statusDiv.textContent = '‚ùå Not logged in';
        }
        
        // Update details
        document.getElementById('authDetails').textContent = JSON.stringify({
          currentUser: currentUser ? {
            uid: currentUser.uid,
            email: currentUser.email,
            displayName: currentUser.displayName,
            emailVerified: currentUser.emailVerified
          } : null,
          authInitialized: authService.authInitialized,
          persistence: auth.config?.persistence || 'unknown'
        }, null, 2);
        
      } catch (error) {
        addLog(`Error checking auth: ${error.message}`, 'error');
      }
    };
    
    // Test login
    window.testLogin = async function() {
      addLog('Testing Google login...');
      
      try {
        // Set persistence first
        addLog('Setting persistence to LOCAL...');
        await setPersistence(auth, browserLocalPersistence);
        addLog('‚úÖ Persistence set');
        
        // Sign in with Google
        addLog('Opening Google sign-in popup...');
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        
        addLog(`‚úÖ Login successful: ${result.user.email}`);
        
        // Update status
        const statusDiv = document.getElementById('authStatus');
        statusDiv.className = 'status success';
        statusDiv.textContent = `‚úÖ Logged in as: ${result.user.email}`;
        
        // Check persistence
        setTimeout(() => {
          checkAuth();
          checkLocalStorage();
        }, 1000);
        
      } catch (error) {
        addLog(`‚ùå Login error: ${error.message}`, 'error');
        const statusDiv = document.getElementById('authStatus');
        statusDiv.className = 'status error';
        statusDiv.textContent = `‚ùå Login failed: ${error.message}`;
      }
    };
    
    // Check local storage
    window.checkLocalStorage = function() {
      addLog('Checking local storage...');
      
      const storage = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.includes('firebase')) {
          storage[key] = localStorage.getItem(key);
        }
      }
      
      document.getElementById('localStorageDetails').textContent = JSON.stringify(storage, null, 2);
      
      const persistenceDiv = document.getElementById('persistenceStatus');
      if (Object.keys(storage).length > 0) {
        persistenceDiv.className = 'status success';
        persistenceDiv.textContent = '‚úÖ Firebase data found in local storage';
        addLog('‚úÖ Firebase data found in local storage');
      } else {
        persistenceDiv.className = 'status error';
        persistenceDiv.textContent = '‚ùå No Firebase data in local storage';
        addLog('‚ùå No Firebase data in local storage');
      }
    };
    
    // Clear everything
    window.clearEverything = async function() {
      if (!confirm('This will logout and clear all data. Continue?')) {
        return;
      }
      
      addLog('Clearing everything...');
      
      try {
        // Sign out
        await auth.signOut();
        addLog('‚úÖ Signed out');
        
        // Clear local storage
        localStorage.clear();
        addLog('‚úÖ Local storage cleared');
        
        // Clear session storage
        sessionStorage.clear();
        addLog('‚úÖ Session storage cleared');
        
        // Clear cache
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          for (const cacheName of cacheNames) {
            await caches.delete(cacheName);
            addLog(`‚úÖ Deleted cache: ${cacheName}`);
          }
        }
        
        addLog('‚úÖ Everything cleared. Reloading...');
        setTimeout(() => {
          window.location.reload();
        }, 1000);
        
      } catch (error) {
        addLog(`‚ùå Error: ${error.message}`, 'error');
      }
    };
    
    // Go to family page
    window.goToFamily = function() {
      addLog('Navigating to family page...');
      window.location.href = 'family.html';
    };
    
    // Listen for auth state changes
    onAuthStateChanged(auth, (user) => {
      addLog(`Auth state changed: ${user ? user.email : 'null'}`);
      checkAuth();
      checkLocalStorage();
    });
    
    // Auto-check on load
    setTimeout(() => {
      addLog('Page loaded, checking auth...');
      checkAuth();
      checkLocalStorage();
    }, 1000);
  </script>
</body>
</html>
