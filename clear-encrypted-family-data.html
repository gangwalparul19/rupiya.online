<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear Encrypted Family Data - Rupiya</title>
    <style>
        * { box-sizing: border-box; }
        body { padding: 20px; background: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #2c3e50; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card-header { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #34495e; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-right: 10px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #3498db; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .alert-warning { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }
        .alert-success { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .log-entry { font-family: monospace; font-size: 12px; padding: 6px 10px; border-bottom: 1px solid #eee; }
        .log-entry.error { background: #ffebee; color: #c62828; }
        .log-entry.success { background: #e8f5e9; color: #2e7d32; }
        .log-entry.info { background: #e3f2fd; color: #1565c0; }
        #logContainer { max-height: 300px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 8px; }
        .text-muted { color: #7f8c8d; font-size: 13px; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Clear Encrypted Family Data</h1>
        
        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Important:</strong> This tool will delete all family groups and invitations that have encrypted data 
            (data with <code>_encrypted</code> field). This is needed because family data was incorrectly encrypted 
            with per-user keys, making it unreadable by other family members.
        </div>

        <div class="card">
            <div class="card-header">Step 1: Login</div>
            <p id="authStatus">Checking authentication...</p>
            <button id="loginBtn" class="btn btn-primary" style="display:none;">Login with Google</button>
        </div>

        <div class="card">
            <div class="card-header">Step 2: Scan for Encrypted Data</div>
            <button id="scanBtn" class="btn btn-info" disabled>Scan Family Data</button>
            <div id="scanResults" class="mt-3"></div>
        </div>

        <div class="card">
            <div class="card-header">Step 3: Clear Encrypted Data</div>
            <button id="clearBtn" class="btn btn-danger" disabled>Clear Encrypted Family Data</button>
            <p class="text-muted">This will delete family groups and invitations with encrypted fields.</p>
        </div>

        <div class="card">
            <div class="card-header">Log</div>
            <div id="logContainer"></div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './assets/js/config/firebase-config.js';
        import { onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { collection, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        let encryptedGroups = [];
        let encryptedInvitations = [];

        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // Auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authStatus').innerHTML = `‚úÖ Logged in as: <strong>${user.email}</strong>`;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('scanBtn').disabled = false;
                log(`Authenticated as ${user.email}`, 'success');
            } else {
                document.getElementById('authStatus').textContent = '‚ùå Not logged in';
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('scanBtn').disabled = true;
                document.getElementById('clearBtn').disabled = true;
            }
        });

        // Login
        document.getElementById('loginBtn').addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                log(`Login error: ${error.message}`, 'error');
            }
        });

        // Scan for encrypted data
        document.getElementById('scanBtn').addEventListener('click', async () => {
            log('Scanning for encrypted family data...', 'info');
            encryptedGroups = [];
            encryptedInvitations = [];

            try {
                // Scan family groups
                const groupsSnapshot = await getDocs(collection(db, 'familyGroups'));
                groupsSnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data._encrypted) {
                        encryptedGroups.push({ id: docSnap.id, data });
                        log(`Found encrypted group: ${docSnap.id}`, 'info');
                    }
                });

                // Scan invitations
                const invitationsSnapshot = await getDocs(collection(db, 'familyInvitations'));
                invitationsSnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data._encrypted) {
                        encryptedInvitations.push({ id: docSnap.id, data });
                        log(`Found encrypted invitation: ${docSnap.id}`, 'info');
                    }
                });

                // Show results
                const resultsDiv = document.getElementById('scanResults');
                const hasEncrypted = encryptedGroups.length + encryptedInvitations.length > 0;
                resultsDiv.innerHTML = `
                    <div class="alert ${hasEncrypted ? 'alert-warning' : 'alert-success'}">
                        <strong>Scan Results:</strong><br>
                        - Encrypted Family Groups: ${encryptedGroups.length}<br>
                        - Encrypted Invitations: ${encryptedInvitations.length}
                    </div>
                `;

                if (hasEncrypted) {
                    document.getElementById('clearBtn').disabled = false;
                    log(`Found ${encryptedGroups.length} encrypted groups and ${encryptedInvitations.length} encrypted invitations`, 'info');
                } else {
                    log('No encrypted family data found - all clear!', 'success');
                }

            } catch (error) {
                log(`Scan error: ${error.message}`, 'error');
                console.error(error);
            }
        });

        // Clear encrypted data
        document.getElementById('clearBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete all encrypted family groups and invitations? This cannot be undone.')) {
                return;
            }

            log('Clearing encrypted family data...', 'info');

            try {
                // Delete encrypted groups
                for (const group of encryptedGroups) {
                    await deleteDoc(doc(db, 'familyGroups', group.id));
                    log(`Deleted encrypted group: ${group.id}`, 'success');
                }

                // Delete encrypted invitations
                for (const invitation of encryptedInvitations) {
                    await deleteDoc(doc(db, 'familyInvitations', invitation.id));
                    log(`Deleted encrypted invitation: ${invitation.id}`, 'success');
                }

                log(`‚úÖ Cleared ${encryptedGroups.length} groups and ${encryptedInvitations.length} invitations`, 'success');
                
                // Reset
                encryptedGroups = [];
                encryptedInvitations = [];
                document.getElementById('clearBtn').disabled = true;
                document.getElementById('scanResults').innerHTML = '<div class="alert alert-success">All encrypted data cleared! You can now create new family groups.</div>';

            } catch (error) {
                log(`Clear error: ${error.message}`, 'error');
                console.error(error);
            }
        });

        log('Page loaded. Please login to continue.', 'info');
    </script>
</body>
</html>
