<!-- Family Account Modals -->
<!-- Include this file in all pages that need family functionality -->

<!-- Create Family Group Modal -->
<div class="modal-overlay" id="createFamilyModal">
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title">Create Family Group</h2>
      <button class="modal-close" id="closeCreateFamilyModal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <p class="mb-3">Create a family group to track finances together with your family members, roommates, or partner.</p>
      
      <form id="createFamilyForm">
        <div class="form-group">
          <label for="familyGroupName">Group Name *</label>
          <input type="text" id="familyGroupName" 
                 placeholder="e.g., Smith Family, Roommates, Our Home" 
                 required maxlength="50">
          <small class="form-help">Choose a name that represents your group</small>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-outline" id="cancelCreateFamily">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="createFamilySubmit">Create Group</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Invite Member Modal -->
<div class="modal-overlay" id="inviteMemberModal">
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title">Invite Family Member</h2>
      <button class="modal-close" id="closeInviteMemberModal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <p class="mb-3">Invite a family member to join your group. They'll receive an invitation and can start tracking their finances.</p>
      
      <form id="inviteMemberForm">
        <input type="hidden" id="inviteGroupId">
        
        <div class="form-group">
          <label for="inviteEmail">Email Address *</label>
          <input type="email" id="inviteEmail" 
                 placeholder="member@example.com" 
                 required>
          <small class="form-help">They'll receive an invitation email</small>
        </div>
        
        <div class="form-group">
          <label for="inviteRole">Role *</label>
          <select id="inviteRole" required>
            <option value="member">Member - Can add/edit own data</option>
            <option value="admin">Admin - Can manage group and members</option>
            <option value="viewer">Viewer - View only access</option>
          </select>
          <small class="form-help">
            <strong>Member:</strong> Can add their own expenses/income<br>
            <strong>Admin:</strong> Can invite/remove members and manage settings<br>
            <strong>Viewer:</strong> Can only view data, cannot add/edit
          </small>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-outline" id="cancelInviteMember">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="inviteMemberSubmit">Send Invitation</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirm Remove Member Modal -->
<div class="modal-overlay" id="removeMemberModal">
  <div class="modal-container modal-sm">
    <div class="modal-header">
      <h2 class="modal-title">Remove Member</h2>
      <button class="modal-close" id="closeRemoveMemberModal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <p>Are you sure you want to remove <strong id="removeMemberName"></strong> from this group?</p>
      <p class="text-muted">They will no longer have access to the group's data.</p>
      
      <input type="hidden" id="removeGroupId">
      <input type="hidden" id="removeMemberId">
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-outline" id="cancelRemoveMember">Cancel</button>
      <button type="button" class="btn btn-danger" id="confirmRemoveMember">Remove</button>
    </div>
  </div>
</div>

<!-- Confirm Delete Group Modal -->
<div class="modal-overlay" id="deleteGroupModal">
  <div class="modal-container modal-sm">
    <div class="modal-header">
      <h2 class="modal-title">Delete Family Group</h2>
      <button class="modal-close" id="closeDeleteGroupModal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <p class="text-danger mb-3">⚠️ Warning: This action cannot be undone!</p>
      <p>Are you sure you want to delete <strong id="deleteGroupName"></strong>?</p>
      <p class="text-muted">All members will be removed from the group. Individual transaction data will not be deleted.</p>
      
      <input type="hidden" id="deleteGroupId">
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-outline" id="cancelDeleteGroup">Cancel</button>
      <button type="button" class="btn btn-danger" id="confirmDeleteGroup">Delete Group</button>
    </div>
  </div>
</div>

<script type="module">
  import familyService from './assets/js/services/family-service.js';
  import familySwitcher from './assets/js/components/family-switcher.js';
  import toast from './assets/js/components/toast.js';

  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initModals);
  } else {
    initModals();
  }

  function initModals() {
    // Create Family Form Handler
    const createFamilyForm = document.getElementById('createFamilyForm');
    const createFamilyModal = document.getElementById('createFamilyModal');
    
    if (createFamilyForm) {
      createFamilyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = document.getElementById('createFamilySubmit');
        const groupName = document.getElementById('familyGroupName').value.trim();
        
        if (!groupName) {
          toast.error('Please enter a group name');
          return;
        }
        
        // Show loading
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';
        
        try {
          const result = await familyService.createFamilyGroup(groupName);
          
          if (result.success) {
            toast.success('Family group created successfully!');
            createFamilyModal.classList.remove('show');
            createFamilyForm.reset();
            
            // Refresh family switcher
            await familySwitcher.refresh();
            
            // Switch to the new group
            familySwitcher.switchToFamily(result.groupId);
          } else {
            toast.error(result.error || 'Failed to create family group');
          }
        } catch (error) {
          console.error('Error creating family group:', error);
          toast.error('Failed to create family group');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }

    // Close modal handlers
    document.getElementById('closeCreateFamilyModal')?.addEventListener('click', () => {
      createFamilyModal?.classList.remove('show');
    });

    document.getElementById('cancelCreateFamily')?.addEventListener('click', () => {
      createFamilyModal?.classList.remove('show');
    });

    document.getElementById('closeInviteMemberModal')?.addEventListener('click', () => {
      document.getElementById('inviteMemberModal')?.classList.remove('show');
    });

    document.getElementById('cancelInviteMember')?.addEventListener('click', () => {
      document.getElementById('inviteMemberModal')?.classList.remove('show');
    });

    document.getElementById('closeRemoveMemberModal')?.addEventListener('click', () => {
      document.getElementById('removeMemberModal')?.classList.remove('show');
    });

    document.getElementById('cancelRemoveMember')?.addEventListener('click', () => {
      document.getElementById('removeMemberModal')?.classList.remove('show');
    });

    document.getElementById('closeDeleteGroupModal')?.addEventListener('click', () => {
      document.getElementById('deleteGroupModal')?.classList.remove('show');
    });

    document.getElementById('cancelDeleteGroup')?.addEventListener('click', () => {
      document.getElementById('deleteGroupModal')?.classList.remove('show');
    });

    // Close modals when clicking outside
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('show');
        }
      });
    });
  }
</script>
