<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encryption Status - Rupiya</title>
    <!-- Inject Firebase config directly for this utility page -->
    <script>
        window.__ENV__ = {
            VITE_FIREBASE_API_KEY: 'AIzaSyDdoA4BKaWbJIzmI9P4Se8Rkxsih6LdFvk',
            VITE_FIREBASE_AUTH_DOMAIN: 'rupiya-abd13.firebaseapp.com',
            VITE_FIREBASE_PROJECT_ID: 'rupiya-abd13',
            VITE_FIREBASE_STORAGE_BUCKET: 'rupiya-abd13.firebasestorage.app',
            VITE_FIREBASE_MESSAGING_SENDER_ID: '999011154370',
            VITE_FIREBASE_APP_ID: '1:999011154370:web:40faebc7a935cdbf51be5b'
        };
    </script>
    <style>
        * { box-sizing: border-box; }
        body { padding: 20px; background: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #2c3e50; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card-header { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #34495e; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-right: 10px; margin-bottom: 10px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .alert-info { background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; }
        .alert-success { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .alert-warning { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }
        .alert-error { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        .log-entry { font-family: monospace; font-size: 12px; padding: 6px 10px; border-bottom: 1px solid #eee; }
        .log-entry.error { background: #ffebee; color: #c62828; }
        .log-entry.success { background: #e8f5e9; color: #2e7d32; }
        .log-entry.info { background: #e3f2fd; color: #1565c0; }
        .log-entry.warn { background: #fff3e0; color: #e65100; }
        #logContainer { max-height: 300px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 8px; }
        .status-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .status-item:last-child { border-bottom: none; }
        .status-icon { font-size: 20px; margin-right: 12px; }
        .status-label { flex: 1; }
        .status-value { font-weight: 600; }
        .status-value.ready { color: #27ae60; }
        .status-value.pending { color: #f39c12; }
        .status-value.error { color: #e74c3c; }
        .text-muted { color: #7f8c8d; font-size: 13px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Encryption Status & Migration</h1>
        
        <div class="alert alert-info">
            <strong>New Automatic Cross-Device Encryption!</strong><br>
            Rupiya now automatically syncs encryption across all your devices. No manual sync needed!
            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                <li><strong>Google users:</strong> Encryption works automatically on any device</li>
                <li><strong>Email/password users:</strong> Just login with your password - encryption syncs automatically</li>
            </ul>
        </div>

        <div id="envError" class="alert alert-error" style="display:none;">
            <strong>‚ö†Ô∏è Configuration Error:</strong> Firebase environment variables not found.
        </div>

        <div class="card">
            <div class="card-header">Authentication Status</div>
            <p id="authStatus">Checking authentication...</p>
            <button id="loginBtn" class="btn btn-primary" style="display:none;">Login with Google</button>
        </div>

        <div class="card">
            <div class="card-header">Encryption Status</div>
            <div id="encryptionStatus">
                <div class="status-item">
                    <span class="status-icon">üîí</span>
                    <span class="status-label">Encryption Enabled</span>
                    <span class="status-value" id="statusEnabled">Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">‚úÖ</span>
                    <span class="status-label">Encryption Ready</span>
                    <span class="status-value" id="statusReady">Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">üë§</span>
                    <span class="status-label">User Type</span>
                    <span class="status-value" id="statusUserType">Checking...</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">üåê</span>
                    <span class="status-label">Cross-Device Sync</span>
                    <span class="status-value" id="statusCrossDevice">Checking...</span>
                </div>
            </div>
            <button id="refreshStatusBtn" class="btn btn-info" disabled>Refresh Status</button>
        </div>

        <div class="card" id="passwordReauthCard" style="display:none;">
            <div class="card-header">Re-authenticate for Encryption</div>
            <p class="text-muted">Your session has expired. Please enter your password to restore encryption.</p>
            <div class="form-group">
                <label for="reauthPassword">Password</label>
                <input type="password" id="reauthPassword" placeholder="Enter your password">
            </div>
            <button id="reauthBtn" class="btn btn-primary">Restore Encryption</button>
        </div>

        <div class="card" id="migrationCard" style="display:none;">
            <div class="card-header">‚ö†Ô∏è Legacy Data Migration</div>
            <div class="alert alert-warning">
                <strong>Migration Required:</strong> Your account has data encrypted with an older system.
                This data needs to be migrated to the new cross-device encryption system.
            </div>
            <p class="text-muted">
                The migration process will:
                <ol>
                    <li>Decrypt your existing data with the old key</li>
                    <li>Re-encrypt it with the new cross-device compatible key</li>
                </ol>
                <strong>Note:</strong> This is a one-time process and may take a few minutes depending on how much data you have.
            </p>
            <button id="startMigrationBtn" class="btn btn-warning">Start Migration</button>
        </div>

        <div class="card">
            <div class="card-header">Test Encryption</div>
            <p class="text-muted">Test that encryption is working correctly.</p>
            <button id="testEncryptionBtn" class="btn btn-success" disabled>Run Encryption Test</button>
            <div id="testResult" style="margin-top: 15px;"></div>
        </div>

        <div class="card">
            <div class="card-header">Log</div>
            <div id="logContainer"></div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './assets/js/config/firebase-config.js';
        import { onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import encryptionService from './assets/js/services/encryption-service.js';
        import authEncryptionHelper from './assets/js/utils/auth-encryption-helper.js';

        let currentUser = null;

        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function updateStatus(id, value, className) {
            const el = document.getElementById(id);
            el.textContent = value;
            el.className = `status-value ${className}`;
        }

        async function refreshEncryptionStatus() {
            if (!currentUser) return;
            
            log('Refreshing encryption status...', 'info');
            
            // Wait for any pending restoration
            await encryptionService.waitForRestore();
            
            const status = encryptionService.getStatus();
            const isGoogle = authEncryptionHelper.isGoogleUser();
            
            updateStatus('statusEnabled', status.enabled ? 'Yes' : 'No', status.enabled ? 'ready' : 'error');
            updateStatus('statusReady', status.ready ? 'Yes' : 'No', status.ready ? 'ready' : 'pending');
            updateStatus('statusUserType', isGoogle ? 'Google' : 'Email/Password', 'ready');
            updateStatus('statusCrossDevice', 'Enabled (Automatic)', 'ready');
            
            // Show password re-auth card if needed for email/password users
            if (!status.ready && !isGoogle) {
                document.getElementById('passwordReauthCard').style.display = 'block';
                log('Password required to restore encryption', 'warn');
            } else {
                document.getElementById('passwordReauthCard').style.display = 'none';
            }
            
            // Check for legacy migration
            const migrationStatus = await encryptionService.migrateFromLegacyEncryption(currentUser.uid);
            if (migrationStatus.needsMigration) {
                document.getElementById('migrationCard').style.display = 'block';
                log('Legacy encryption data detected - migration available', 'warn');
            }
            
            document.getElementById('testEncryptionBtn').disabled = !status.ready;
            
            if (status.ready) {
                log('Encryption is ready!', 'success');
            }
        }

        // Auth state
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('authStatus').innerHTML = `‚úÖ Logged in as: <strong>${user.email}</strong><br><small>UID: ${user.uid}</small>`;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('refreshStatusBtn').disabled = false;
                log(`Authenticated as ${user.email}`, 'success');
                
                // Initialize encryption for Google users automatically
                if (authEncryptionHelper.isGoogleUser()) {
                    log('Google user detected - initializing encryption...', 'info');
                    await authEncryptionHelper.initializeForGoogleUser(user.uid);
                }
                
                await refreshEncryptionStatus();
            } else {
                document.getElementById('authStatus').textContent = '‚ùå Not logged in';
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('refreshStatusBtn').disabled = true;
                document.getElementById('testEncryptionBtn').disabled = true;
                updateStatus('statusEnabled', 'N/A', 'pending');
                updateStatus('statusReady', 'N/A', 'pending');
                updateStatus('statusUserType', 'N/A', 'pending');
                updateStatus('statusCrossDevice', 'N/A', 'pending');
            }
        });

        // Login
        document.getElementById('loginBtn').addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                log(`Login error: ${error.message}`, 'error');
            }
        });

        // Refresh status
        document.getElementById('refreshStatusBtn').addEventListener('click', refreshEncryptionStatus);

        // Re-authenticate with password
        document.getElementById('reauthBtn').addEventListener('click', async () => {
            const password = document.getElementById('reauthPassword').value;
            if (!password) {
                log('Please enter your password', 'error');
                return;
            }
            
            log('Initializing encryption with password...', 'info');
            const success = await authEncryptionHelper.initializeAfterLogin(password, currentUser.uid);
            
            if (success) {
                log('Encryption restored successfully!', 'success');
                document.getElementById('reauthPassword').value = '';
                await refreshEncryptionStatus();
            } else {
                log('Failed to restore encryption - check your password', 'error');
            }
        });

        // Test encryption
        document.getElementById('testEncryptionBtn').addEventListener('click', async () => {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '<p>Testing encryption...</p>';
            
            try {
                const testData = 'Hello, this is a test message! üîê ' + new Date().toISOString();
                log(`Original: ${testData}`, 'info');
                
                const encrypted = await encryptionService.encryptValue(testData);
                log(`Encrypted: ${encrypted.substring(0, 50)}...`, 'info');
                
                const decrypted = await encryptionService.decryptValue(encrypted);
                log(`Decrypted: ${decrypted}`, 'info');
                
                if (decrypted === testData) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ Encryption Test Passed!</strong><br>
                            Data was successfully encrypted and decrypted.
                        </div>
                    `;
                    log('Encryption test PASSED!', 'success');
                } else {
                    throw new Error('Decrypted data does not match original');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå Encryption Test Failed</strong><br>
                        ${error.message}
                    </div>
                `;
                log(`Encryption test FAILED: ${error.message}`, 'error');
            }
        });

        // Migration (placeholder - actual migration would need more work)
        document.getElementById('startMigrationBtn').addEventListener('click', async () => {
            log('Migration feature coming soon...', 'warn');
            alert('Migration feature is coming soon. For now, you may need to re-enter your data if you have issues with old encrypted data.');
        });

        log('Page loaded. Please login to check encryption status.', 'info');
    </script>
</body>
</html>
